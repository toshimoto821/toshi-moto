name: Reusable Cypress Run and Commit

on:
  workflow_call:
    inputs:
      branch:
        description: "The branch name"
        required: true
        type: string
      github-token:
        description: "GitHub Token"
        required: true
        type: string

jobs:
  cypress-and-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
          submodules: "recursive"

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 18

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cypress Run
        env:
          CYPRESS_RUNNING: true
        run: |
          npx nx run web-ui-e2e:e2e-ci

      - name: Configure git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Updating screenshots
        run: |
          git add .
          git commit -m "Update images"
          echo "COMMIT_HASH=$(git rev-parse HEAD)" >> $GITHUB_ENV

      - name: GitHub Push
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ inputs.github-token }}
          branch: ${{ inputs.branch }}

      - name: Construct Commit URL
        run: echo "COMMIT_URL=https://github.com/${GITHUB_REPOSITORY}/commit/${{ env.COMMIT_HASH }}" >> $GITHUB_ENV

      - name: Comment on PR
        uses: ./.github/scripts/comment-on-pr
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: "Images updated. [Check them out](${{ env.COMMIT_URL }})!"
